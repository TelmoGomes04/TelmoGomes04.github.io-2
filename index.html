<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AR Test</title>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://preview.babylonjs.com/gui/babylon.gui.min.js"></script>
    <script src="https://preview.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <style>
        html, body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #renderCanvas {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <canvas id="renderCanvas"></canvas>
    <script>
    document.addEventListener("DOMContentLoaded", function () {
        var carMesh = null;
        var touchStart = null;
        var initialY = null;
        var initialScale = null;
        var initialRotation = null;
        var planeDetected = false;
        var initialDistance = null;
        var initialAngle = null;

        var position = false ;
        var scaling = false ;
        var rotation = false ;

        var canvas = document.getElementById("renderCanvas");
        var engine = new BABYLON.Engine(canvas, true, { preserveDrawingBuffer: true, stencil: true });

        var createScene = function() {
            var scene = new BABYLON.Scene(engine);

            var camera = new BABYLON.FreeCamera("camera1", new BABYLON.Vector3(0, 1, -2), scene);
            camera.setTarget(BABYLON.Vector3.Zero());

            var light = new BABYLON.HemisphericLight("light1", new BABYLON.Vector3(0, 1, 0), scene);
            light.intensity = 0.7;

            var advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");

            var loadingText = new BABYLON.GUI.TextBlock();
            loadingText.text = "Loading...";
            loadingText.color = "white";
            loadingText.fontSize = 24;
            loadingText.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;
            loadingText.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_CENTER;
            loadingText.isVisible = true;

            advancedTexture.addControl(loadingText);

            function loadCarMesh(scene) {
                BABYLON.SceneLoader.ImportMesh("", "media/gltf/F3_Car/", "scene.gltf", scene, function (loadedMeshes) {
                    carMesh = loadedMeshes[0]; // Assumindo que a mesh do carro está no índice 0
                    carMesh.isVisible = false; // Inicialmente ocultar a mesh
                    carMesh.scaling = new BABYLON.Vector3(0.3, 0.3, 0.3); // Definir escala desejada
                    loadingText.isVisible = false;
                },
                // Função de progresso
                function (event) {
                    loadingText.text = "Loading: " + (event.loaded * 100 / event.total).toFixed() + "%";
                });
            }

            loadCarMesh(scene);
            
            
            scene.createDefaultXRExperienceAsync({ floorMeshes: [], uiOptions: { sessionMode: "immersive-ar" } }).then((xrHelper) => {
                const fm = xrHelper.baseExperience.featuresManager;
                const xrTest = fm.enableFeature(BABYLON.WebXRHitTest, "latest");

                xrTest.onHitTestResultObservable.add((results) => {
                    if (!planeDetected && results.length > 0 && carMesh && !carMesh.isVisible) {
                        // Plane detection bem-sucedido, exiba a mesh do carro no plano detectado
                        var hitResult = results[0];
                        carMesh.isVisible = true;
                        carMesh.position = hitResult.transformationMatrix.getTranslation();
                        // Outras configurações necessárias após o plane detection
                        planeDetected = true; // Marque o plane detection como concluído 
                        carMesh.position.y = initialY;
                        moveButton.isVisible = true;
                        scaleButton.isVisible = true;
                        rotateButton.isVisible = true;
                    }

                });
                // Criar botão "Move"
                var moveButton = BABYLON.GUI.Button.CreateSimpleButton("moveButton", "Move");
                moveButton.width = "110px";
                moveButton.height = "110px";
                moveButton.color = "black";
                moveButton.cornerRadius = 20;
                moveButton.background = "gray";
                moveButton.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM; // Alinhamento vertical no fundo
                moveButton.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER; // Alinhamento horizontal no centro
                moveButton.left = "-120px";
                moveButton.isVisible = false;
                moveButton.onPointerUpObservable.add(function() {
                    position = !position;
                    scaling = false;
                    rotation = false;
                    console.log("Position :",position);
                    if(position) {
                        moveButton.background = "green";
                        scaleButton.background = "gray";
                        scaling = false;
                        rotateButton.background = "gray";
                        rotation = false;
                    } else {
                        moveButton.background = "gray";
                    }
                });
                advancedTexture.addControl(moveButton); 

                // Criar botão "Scale"
                var scaleButton = BABYLON.GUI.Button.CreateSimpleButton("scaleButton", "Scale");
                scaleButton.width = "110px";
                scaleButton.height = "110px";
                scaleButton.color = "black";
                scaleButton.cornerRadius = 20;
                scaleButton.background = "gray";
                scaleButton.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM; // Alinhamento vertical no fundo
                scaleButton.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER; // Alinhamento horizontal no centro
                //scaleButton.left = "0px";
                scaleButton.isVisible = false;
                scaleButton.onPointerUpObservable.add(function() {
                    scaling = !scaling;
                    position = false;
                    rotation = false;
                    console.log("Position :",scaling);
                    if(scaling) {
                        scaleButton.background = "green";
                        moveButton.background = "gray";
                        position = false;
                        rotateButton.background = "gray";
                        rotation = false;
                    } else {
                        scaleButton.background = "gray";
                    }
                });
                advancedTexture.addControl(scaleButton); 

                // Criar botão "Rotate"
                var rotateButton = BABYLON.GUI.Button.CreateSimpleButton("rotateButton", "Rotate");
                rotateButton.width = "110px";
                rotateButton.height = "110px";
                rotateButton.color = "black";
                rotateButton.cornerRadius = 20;
                rotateButton.background = "gray";
                rotateButton.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM; // Alinhamento vertical no fundo
                rotateButton.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER; // Alinhamento horizontal no centro
                rotateButton.left = "120px"; // Distância do botão "Scale"
                rotateButton.isVisible = false;
                rotateButton.onPointerUpObservable.add(function() {
                    rotation = !rotation;
                    position = false;
                    scaling = false;
                    console.log("Position :",rotation);
                    if(rotation) {
                        rotateButton.background = "green";
                        moveButton.background = "gray";
                        position = false;
                        scaleButton.background = "gray";
                        scaling = false;
                    } else {
                        rotateButton.background = "gray";
                    }
                });
                advancedTexture.addControl(rotateButton);  
            });

            return scene;
        };

        var scene = createScene();

        engine.runRenderLoop(function () {
            if (scene) {
                scene.render();
            }
        });

        window.addEventListener("resize", function () {
            engine.resize();
        });

        canvas.addEventListener('touchstart', function(event) {
            if (event.touches.length === 2) {
                var touch1 = event.touches[0];
                var touch2 = event.touches[1];
                touchStart = new BABYLON.Vector3(touch1.clientX, touch1.clientY, 0);
                var secondTouchStart = new BABYLON.Vector3(touch2.clientX, touch2.clientY, 0);
                initialDistance = BABYLON.Vector3.Distance(touchStart, secondTouchStart);
                initialScale = carMesh.scaling.x;
            }
        });
        
        canvas.addEventListener('touchmove', function(event) {
            if (event.touches.length === 2) {
                var touch1 = event.touches[0];
                var touch2 = event.touches[1];
                touchStart = new BABYLON.Vector3(touch1.clientX, touch1.clientY, 0);
                var secondTouchStart = new BABYLON.Vector3(touch2.clientX, touch2.clientY, 0);
                var currentDistance = BABYLON.Vector3.Distance(touchStart, secondTouchStart);
                var scaleFactor = currentDistance / initialDistance;
                carMesh.scaling = new BABYLON.Vector3(initialScale * scaleFactor, initialScale * scaleFactor, initialScale * scaleFactor);
            }
        });
        
        canvas.addEventListener('touchend', function(event) {
            if (event.touches.length < 2) {
                initialDistance = null;
                initialScale = null;
            }
        });
        
    });
    </script>
</body>
</html>
